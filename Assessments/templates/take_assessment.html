{% extends 'base.html' %}



{% block content %}
<div id="quizApp">
    <h3>[[ assessment.title ]]</h3>
    <p class="text-muted">
        [[ assessment.subject.name ]] | Duration: [[ assessment.duration_minutes ]] minutes
    </p>

    <!-- NAME INPUT -->
    <div v-if="!nameSubmitted && !alreadyTaken" class="mb-4">
        <label for="studentName" class="form-label">Enter Your Name:</label>
        <input type="text" id="studentName" v-model="studentName" class="form-control" placeholder="e.g. Jane Doe" required>
        <button class="btn btn-primary mt-2" @click="checkIfTaken" :disabled="!studentName">Proceed</button>
    </div>

    <!-- BLOCKED MESSAGE -->
    <div v-if="alreadyTaken" class="alert alert-danger">
        You have already taken this assessment.
        <a href="#">View Results</a>
    </div>

    <!-- WELCOME MESSAGE & START BUTTON -->
    <div v-if="nameSubmitted && !quizStarted" class="text-center my-4">
        <h4 class="mb-3">Welcome,[[ studentName ]]!</h4>
        <p class="lead">Wishing you all the best in your assessment.</p>
        <button class="btn btn-lg btn-success" @click="startAssessment">Click to Start Assessment</button>
    </div>

    <!-- TIMER & QUESTIONS -->
    <div v-if="quizStarted">
        <div class="alert alert-warning">
            ‚è∞ Time Remaining: <strong>[[ timer.minutes ]]m [[ timer.seconds ]]s</strong>
        </div>

        <div v-if="currentQuestion">
            <div class="card mb-3">
                <div class="card-header">Question [[ currentIndex + 1 ]] of [[ questions.length ]]</div>
                <div class="card-body">
                    <h3><p class="card-text">[[ currentQuestion.text ]]</p></h3>
                    <ul class="list-group">
                        <li v-for="choice in currentQuestion.choices"
                            :key="choice.id"
                            class="list-group-item"
                            :class="{ active: selectedAnswers[currentIndex] === choice.id }"
                            @click="selectAnswer(choice.id)">
                            [[ choice.text ]]
                        </li>
                    </ul>
                </div>
            </div>

            <div class="d-flex justify-content-between">
                <button class="btn btn-secondary" @click="prev" :disabled="currentIndex === 0">Previous</button>
                <button class="btn btn-secondary" @click="next" :disabled="currentIndex === questions.length - 1">Next</button>
            </div>

            <div class="mt-3" v-if="currentIndex === questions.length - 1">
                <button class="btn btn-primary" @click="submitQuiz" :disabled="!selectedAnswers[currentIndex]">
                    Submit Assessment
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const { createApp } = Vue;

createApp({
    delimiters: ['[[', ']]'],
    data() {
        return {
            studentName: '',
            nameSubmitted: false,
            alreadyTaken: false,
            quizStarted: false,
            questions: {{ questions_json|safe }},
            currentIndex: 0,
            selectedAnswers: [],
            timer: {
                totalSeconds: {{ assessment.duration_minutes }} * 60,
                minutes: 0,
                seconds: 0,
                interval: null
            },
            assessment: {
                id: {{ assessment.id }},
                title: "{{ assessment.title }}",
                subject: {
                    name: "{{ assessment.subject.name }}"
                },
                duration_minutes: {{ assessment.duration_minutes }}
            }
        };
    },
    computed: {
        currentQuestion() {
            return this.questions[this.currentIndex];
        }
    },
    methods: {
        checkIfTaken() {
            const name = this.studentName.trim();
            if (!name) return;

            fetch(`/assessment/check/assessment/${this.assessment.id}/?name=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.taken) {
                        this.alreadyTaken = true;
                    } else {
                        this.nameSubmitted = true;
                    }
                });
        },
        startAssessment() {
            this.quizStarted = true;
            this.updateTimerDisplay();
            this.startTimer();
        },
        updateTimerDisplay() {
            this.timer.minutes = Math.floor(this.timer.totalSeconds / 60);
            this.timer.seconds = this.timer.totalSeconds % 60;
        },
        startTimer() {
            this.timer.interval = setInterval(() => {
                if (this.timer.totalSeconds > 0) {
                    this.timer.totalSeconds--;
                    this.updateTimerDisplay();
                } else {
                    clearInterval(this.timer.interval);
                    alert("Time is up! Submitting your assessment...");
                    this.submitQuiz(true);
                }
            }, 1000);
        },
        selectAnswer(choiceId) {
            this.selectedAnswers[this.currentIndex] = choiceId;
        },
        next() {
            if (this.currentIndex < this.questions.length - 1)
                this.currentIndex++;
        },
        prev() {
            if (this.currentIndex > 0)
                this.currentIndex--;
        },
        submitQuiz(auto = false) {
            const unanswered = this.questions.findIndex((q, index) => !this.selectedAnswers[index]);
            if (unanswered !== -1 && !auto) {
                alert(`Please answer question ${unanswered + 1} before submitting.`);
                this.currentIndex = unanswered;
                return;
            }

            fetch(`/assessment/assessment/${this.assessment.id}/submit/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    answers: this.selectedAnswers,
                    student_name: this.studentName
                })
            })
            .then(response => response.json())
            .then(data => {
                window.location.href = data.redirect_url;
            });
        }
    }
}).mount('#quizApp');
</script>
{% endblock %}
