{% extends 'base.html' %}

{% block title %} {{ subject.name }} {% endblock%}
{% block extra_head %}
{% endblock %}

{% block content %}
<div id="app">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Strands for : {{ subject.name }}</h2>
        <hr>
        <a href="#" class="btn btn-warning" @click.prevent="showModal = true">Add Strand</a>
    </div>
    <hr>
    <div class="d-flex flex-wrap gap-3">
    <div v-for="strand in strands"
         :key="strand.id"
         class="card"
         > <!-- ðŸ‘ˆ uniform size -->

        <div class="card-body">
            <h4 class="card-title">[[ strand.name ]]</h4>
            <div class="mt-auto d-flex gap-2"> <!-- ðŸ‘ˆ pushes buttons to bottom -->
                <a :href="`{% url 'api_substrands' 0 %}`.replace('0', strand.id)"
                   class="btn btn-warning btn-sm">View</a>
            </div>
        </div>
    </div>
</div>


    <!-- Modal -->
    <div v-if="showModal" class="modal fade show d-block" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Strand</h5>
                    <button type="button" class="btn-close" @click="showModal = false"></button>
                </div>
                <div class="modal-body">
                    <input type="text" v-model="newStrand" placeholder="Enter strand name" class="form-control">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @click="showModal = false">Cancel</button>
                    <button class="btn btn-primary" @click="addStrand">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… Success Alert -->
    <div v-if="successMessage" class="alert alert-success position-fixed bottom-0 end-0 m-3" style="z-index:999;">
        [[ successMessage ]]
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            return {
                strands: {{ strands_json|safe }},
                newStrand: '',
                showModal: false,
                successMessage: '',
                subjectId: {{ view.kwargs.subject_id }}
            }
        },
        methods: {
            async addStrand() {
                if (!this.newStrand.trim()) {
                    alert('Please enter a strand name.');
                    return;
                }

                try {
                    axios.defaults.headers.common['X-CSRFToken'] = '{{ csrf_token }}';

                    const response = await axios.post(`/api/subjects/${this.subjectId}/add-strand/`, {
                        name: this.newStrand
                    });

                    this.strands.push(response.data);
                    this.newStrand = '';
                    this.showModal = false;

                    // âœ… Show success message
                    this.successMessage = 'Strand added successfully!';
                    setTimeout(() => this.successMessage = '', 3000);
                } catch (error) {
                    console.error(error);
                    alert('Failed to add strand.');
                }
            }
        }
    }).mount('#app');
});
</script>
{% endblock %}
